# Azure Operator (for Kubernetes)

> This project is experimental. Expect the API to change. It is not recommended for production environments.

## Introduction

Kubernetes offers the facility of extending it's API through the concept of 'Operators' ([Introducing Operators: Putting Operational Knowledge into Software](https://coreos.com/blog/introducing-operators.html)). This repository contains the resources and code to provision a Resource group and Azure Event Hub using Kubernetes operator.

The Azure Operator comprises of:
- The golang application is a Kubernetes controller that watches Customer Resource Definitions (CRDs) that define a Resource Group and Event Hub 

The project was built using

1. [Kubebuilder](https://book.kubebuilder.io/)

### Prerequisites And Assumptions

1. You have GoLang installed.
2. You have the kubectl command line (kubectl CLI) installed.
3. You have acess to a Kubernetes cluster. It can be a local hosted Cluster like [Minikube](https://kubernetes.io/docs/tasks/tools/install-minikube/), [Kind](https://github.com/kubernetes-sigs/kind) or, Docker for desktop installed localy with RBAC enabled. if you opt for Azure Kubernetes Service ([AKS](https://azure.microsoft.com/en-au/services/kubernetes-service/)), you can use: `az aks get-credentials --resource-group $RG_NAME --name $Cluster_NAME`
Kubectl: Client version 1.14 Server Version 1.12
4. [kustomize](https://github.com/kubernetes-sigs/kustomize) is also needed

Basic commands to check your cluster

```shell
    kubectl config get-contexts
    kubectl cluster-info
    kubectl version
    kubectl get pods -n kube-system
```
### Run Souce Code

1. Clone the repo

2. Install the azure_v1_eventhub CRD in the configured Kubernetes cluster folder ~/.kube/config, 
run `kubectl apply -f config/crd/bases` or `make install`

3. Update the values in `azure_v1_eventhub.yaml` to reflect the resource group and event hub you want to provision

4. Set the environment variables AZURE_TENANT_ID, AZURE_CLIENT_ID, AZURE_CLIENT_SECRET, AZURE_SUBSCRIPTION_ID
If you are running it on Windows the environment variables should not have quotes. It should be set in this way:
SET  AZURE_TENANT_ID=11326305-a551-4098-af36-2fb5d4313888
and the VSCode should be run from the same session/command window

### How to extend the operator and build your own images

#### Updating the Azure operator:

This Repo is generated by [Kubebuilder](https://book.kubebuilder.io/).

To Extend the operator `Telstra.Dx.AzureOperator`:

1. Run `dep ensure` to download dependencies. It doesn't show any progress bar and takes a while to download all of dependencies.
2. Update `api\v1\eventhub_types.go`.
3. Regenerate CRD `make manifests`.
4. Install updated CRD `make install`
5. Generate code `make generate`
6. Update operator `controller\eventhub_controller.go`
7. Update tests and run `make test`
8. Build `make build`
9. Deploy `make deploy`
