# Adding a new code generated resource to ASO v2

This document discusses how to add a new resource to the ASO v2 code generation configuration. Check out [this PR](TODO) if you'd like to see what the end product looks like.

## What resources can be code generated?
Any ARM resource can be generated. There are a few ways to determine if a resource is an ARM resource:
1. If the resource is defined in the [ARM template JSON schema](https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json), or the [auto-generated ARM template JSON schema](https://schema.management.azure.com/schemas/common/autogeneratedResources.json) it is an ARM resource.
2. If the resource is defined in a `resource-manager` folder in the [Azure REST API specs](https://github.com/Azure/azure-rest-api-specs/tree/main/specification) repo, it is an ARM resource.

If the resource is not in either of the above places and cannot be deployed via an ARM template, then it's not an ARM resource and currently cannot be code generated.

## Determine a resource to add
There are three key pieces of information required before adding a resource to the code generation configuration file, and each of them can be found in the 
[ARM template JSON schema](https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json) or the [auto-generated ARM template JSON schema](https://schema.management.azure.com/schemas/common/autogeneratedResources.json). To get started, find the entry for the resource in one of the two templates mentioned. For example, the entry for Azure Network Security Groups looks like this:
`{ "$ref": "https://schema.management.azure.com/schemas/2020-11-01/Microsoft.Network.json#/resourceDefinitions/networkSecurityGroups" },`

**Note**: In many cases there will be multiple entry's for the same resource, each with a different `api-version`. It is _strongly_ recommended that you use the latest available non-preview `api-version`.

1. The `name` of the resource.

   You usually know this going in. In our example above, the name of the resource is `networkSecurityGroups`.
2. The `group` the resource is in. 

   This is usually named after the Azure service, for example `microsoft.resources` or `microsoft.documentdb`. In our example entry from above, this is `microsoft.network`.
3. The `api-version` of the resource.

   This is usually a date, sometimes with a `-preview` suffix. In our example entry from above, this is `2020-11-01`.

## Adding the resource to the code generation configuration file
The code generation configuration file is located [here](../../hack/generator/azure-arm.yaml). To add a new resource to this file, find the `exportFilters` section of the file and scroll down until you get to a block of `exportFilters` for individual resources. 

Add a new `exportFilter` of kind `include-transitive` at the end of that block, right _above_ this section:
```yaml
  # Exclude everything else as we are operating on an opt-in basis at the moment:
  - action: exclude
    because: We don't want to generate anything else, at the moment.
```

Your export filter should look like this:
```yaml
- action: include-transitive
  group: <group>
  version: v*api<api-version with dashes removed>
  name: <resource name, typically just remove the trailing "s">
  because: "including <resource>"
```

In the case of our example above, that ends up being:
```yaml
- action: include-transitive
  group: microsoft.network
  version: v*api20201101
  name: NetworkSecurityGroup
  because: "including NSG"
```

## Run the code generator

See [the code generator README](/hack/README.md) for how to run the code generator.

## Fix any errors raised by the code generator

TODO: expand on common errors

## Examine the generated resource
The Azure REST API specs and ARM template JSON schemas are not perfect. Sometimes they mark a `readonly` property as mutable or have another error or mistake. Have a look through the [generated code](/hack/generated/_apis/) in the directory named after the `group` of the resource that was added. In our `NetworkSecurityGroups` example, this is at `/hack/generated/_apis/microsoft.network/v1alpha1api20201101/network_security_group_types_gen.go`

If you do identify properties which should be removed or changed, you can make customizations to the resource in the `typeTransformers` section of the code generation config. The most common issues have their own sections:

1. `# Deal with readonly properties that were not properly pruned in the JSON schema`
2. `# Deal with properties that should have been marked readOnly but weren't`

## Write a CRUD test for the resource
The best way to do this is to start from an [existing test](/hack/generated/controllers/crd_cosmosdb_test.go) and modify it to work for your resource. It can also be helpful to refer to examples in the [ARM templates GitHub repo](https://github.com/Azure/azure-quickstart-templates).

## Run the CRUD test for the resource and commit the recording
See [the code generator README](/hack/README.md#record-replay) for how to run recording tests.

## Add a new sample
The samples are located in the [samples directory](/hack/generated/config/samples). There should be at least one sample for each kind of supported resource. These currently need to be added manually. It's possible in the future we will automatically generate samples similar to how we automatically generate CRDs and types, but that doesn't happen today.

## Send a PR
You're all done!
