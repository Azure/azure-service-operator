<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Reconciler Extensions #  Context #  We are discovering inconsistencies in the way different Azure Resource Providers behave.
These inconsistencies are anticipated. Given the number of disparate teams independently implementing their providers and given the way the ARM guidance has changed over time, differences in behaviour are to be expected.
For example, the Azure Redis Resource Provider can return a HTTP conflict (409) with a retry message indicating that it&rsquo;s not a fatal error but a transient one.">
<meta name="theme-color" content="#FFFFFF">
<meta name="color-scheme" content="light dark"><meta property="og:title" content="" />
<meta property="og:description" content="Reconciler Extensions #  Context #  We are discovering inconsistencies in the way different Azure Resource Providers behave.
These inconsistencies are anticipated. Given the number of disparate teams independently implementing their providers and given the way the ARM guidance has changed over time, differences in behaviour are to be expected.
For example, the Azure Redis Resource Provider can return a HTTP conflict (409) with a retry message indicating that it&rsquo;s not a fatal error but a transient one." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://azure.github.io/azure-service-operator/architecture-decision-records/adr-2022-01-reconciler-extensions/" /><meta property="article:section" content="architecture-decision-records" />



<title>Adr 2022 01 Reconciler Extensions | Azure Service Operator</title>
<link rel="manifest" href="/azure-service-operator/manifest.json">
<link rel="icon" href="/azure-service-operator/favicon.png" type="image/x-icon">
<link rel="stylesheet" href="/azure-service-operator/book.min.46181bc93375ba932026e753b37c40e6ff8bb16a9ef770c78bcc663e4577b1ba.css" integrity="sha256-RhgbyTN1upMgJudTs3xA5v&#43;LsWqe93DHi8xmPkV3sbo=" crossorigin="anonymous">
  <script defer src="/azure-service-operator/flexsearch.min.js"></script>
  <script defer src="/azure-service-operator/en.search.min.3319db11ea185b4b3ce82df40493d02cbfef661497d6a6c17cb31632457dd4aa.js" integrity="sha256-MxnbEeoYW0s86C30BJPQLL/vZhSX1qbBfLMWMkV91Ko=" crossorigin="anonymous"></script>
<!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->
  
</head>
<body dir="ltr">
  <input type="checkbox" class="hidden toggle" id="menu-control" />
  <input type="checkbox" class="hidden toggle" id="toc-control" />
  <main class="container flex">
    <aside class="book-menu">
      <div class="book-menu-content">
        
  <nav>
<h2 class="book-brand">
  <a class="flex align-center" href="/azure-service-operator/"><span>Azure Service Operator</span>
  </a>
</h2>


<div class="book-search">
  <input type="text" id="book-search-input" placeholder="Search" aria-label="Search" maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>












  

  



  
  <ul>
    
      
        <li>
          
  
  

  
    <span>Userâ€™s Guide</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://azure.github.io/azure-service-operator/introduction/annotations/" class="">Annotations</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://azure.github.io/azure-service-operator/introduction/authentication/" class="">Authentication</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://azure.github.io/azure-service-operator/introduction/conditions/" class="">Conditions</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://azure.github.io/azure-service-operator/introduction/diagnosing-problems/" class="">Diagnosing Problems</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://azure.github.io/azure-service-operator/introduction/multitenant-deployment/" class="">Multitenant Deployment</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://azure.github.io/azure-service-operator/introduction/secrets/" class="">Secrets</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://azure.github.io/azure-service-operator/introduction/resources/" class="">Resources</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://azure.github.io/azure-service-operator/introduction/installing-from-yaml/" class="">Installation: From YAML</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://azure.github.io/azure-service-operator/introduction/tutorial-cosmosdb/" class="">Tutorial: CosmosDB to-do List</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://azure.github.io/azure-service-operator/introduction/tutorial-postgresql/" class="">Tutorial: PostgreSQL Votes</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>For Contributors</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://azure.github.io/azure-service-operator/contributing/contributing/" class="">Contributing</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://azure.github.io/azure-service-operator/contributing/add-a-new-code-generated-resource/" class="">Add a New Code Generated Resource</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://azure.github.io/azure-service-operator/contributing/create-a-new-release/" class="">Create a New Release</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://azure.github.io/azure-service-operator/contributing/generator-overview/" class="">Generator Overview</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>Design &amp; Specifications</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://azure.github.io/azure-service-operator/design/clarifying-object-structure/" class="">Clarifying Object Structure</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://azure.github.io/azure-service-operator/design/crossplane/" class="">Crossplane</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://azure.github.io/azure-service-operator/design/defaulter-validator/" class="">Defaulter Validator</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://azure.github.io/azure-service-operator/design/resource-states/" class="">Resource States</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://azure.github.io/azure-service-operator/design/secrets/" class="">Secrets</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://azure.github.io/azure-service-operator/design/type-references-and-ownership/" class="">Type References and Ownership</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://azure.github.io/azure-service-operator/design/versioning/" class="">Versioning</a>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <span>Case Studies</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://azure.github.io/azure-service-operator/design/versioning/case-studies/chained-storage-versions/" class="">Chained Storage Versions</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://azure.github.io/azure-service-operator/design/versioning/case-studies/fixed-storage-version/" class="">Fixed Storage Version</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://azure.github.io/azure-service-operator/design/versioning/case-studies/rolling-storage-versions/" class="">Rolling Storage Versions</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://azure.github.io/azure-service-operator/architecture-decision-records/" class="">Architecture Decision Records</a>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://azure.github.io/azure-service-operator/architecture-decision-records/adr-2021-02-property-conversions/" class="">2021-02: Property Conversions</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://azure.github.io/azure-service-operator/architecture-decision-records/adr-2020-11-abstract-syntax-trees/" class="">2020-11: AST Library Choice</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://azure.github.io/azure-service-operator/architecture-decision-records/adr-2020-07-pipeline-architecture/" class="">2020-07: Pipeline Architecture</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://azure.github.io/azure-service-operator/architecture-decision-records/adr-2020-04-code-generation/" class="">2020-04: Why Code Generation?</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://azure.github.io/azure-service-operator/architecture-decision-records/adr-2021-06-api-version-recovery/" class="">Adr 2021 06 API Version Recovery</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://azure.github.io/azure-service-operator/architecture-decision-records/adr-2021-08-committing-generated-code/" class="">Adr 2021 08 Committing Generated Code</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://azure.github.io/azure-service-operator/architecture-decision-records/adr-2022-01-reconciler-extensions/" class=" active">Adr 2022 01 Reconciler Extensions</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://azure.github.io/azure-service-operator/architecture-decision-records/adr-2022-02-backward-compatibility/" class="">Adr 2022 02 Backward Compatibility</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>References</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://azure.github.io/azure-service-operator/reference/authorization.v1alpha1api20200801preview/" class="">Authorization.V1alpha1api20200801preview</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://azure.github.io/azure-service-operator/reference/batch.v1alpha1api20210101/" class="">Batch.V1alpha1api20210101</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://azure.github.io/azure-service-operator/reference/cache.v1alpha1api20201201/" class="">Cache.V1alpha1api20201201</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://azure.github.io/azure-service-operator/reference/cache.v1alpha1api20210301/" class="">Cache.V1alpha1api20210301</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://azure.github.io/azure-service-operator/reference/compute.v1alpha1api20200930/" class="">Compute.V1alpha1api20200930</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://azure.github.io/azure-service-operator/reference/compute.v1alpha1api20201201/" class="">Compute.V1alpha1api20201201</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://azure.github.io/azure-service-operator/reference/compute.v1alpha1api20210701/" class="">Compute.V1alpha1api20210701</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://azure.github.io/azure-service-operator/reference/containerregistry.v1alpha1api20210901/" class="">Containerregistry.V1alpha1api20210901</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://azure.github.io/azure-service-operator/reference/containerservice.v1alpha1api20210501/" class="">Containerservice.V1alpha1api20210501</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://azure.github.io/azure-service-operator/reference/dbformysql.v1alpha1api20210501/" class="">Dbformysql.V1alpha1api20210501</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://azure.github.io/azure-service-operator/reference/dbforpostgresql.v1alpha1api20210601/" class="">Dbforpostgresql.V1alpha1api20210601</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://azure.github.io/azure-service-operator/reference/documentdb.v1alpha1api20210515/" class="">Documentdb.V1alpha1api20210515</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://azure.github.io/azure-service-operator/reference/eventgrid.v1alpha1api20200601/" class="">Eventgrid.V1alpha1api20200601</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://azure.github.io/azure-service-operator/reference/eventhub.v1alpha1api20211101/" class="">Eventhub.V1alpha1api20211101</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://azure.github.io/azure-service-operator/reference/insights.v1alpha1api20180501preview/" class="">Insights.V1alpha1api20180501preview</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://azure.github.io/azure-service-operator/reference/insights.v1alpha1api20200202/" class="">Insights.V1alpha1api20200202</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://azure.github.io/azure-service-operator/reference/managedidentity.v1alpha1api20181130/" class="">Managedidentity.V1alpha1api20181130</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://azure.github.io/azure-service-operator/reference/network.v1alpha1api20201101/" class="">Network.V1alpha1api20201101</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://azure.github.io/azure-service-operator/reference/operationalinsights.v1alpha1api20210601/" class="">Operationalinsights.V1alpha1api20210601</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://azure.github.io/azure-service-operator/reference/resources.v1alpha1api20200601/" class="">Resources.V1alpha1api20200601</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://azure.github.io/azure-service-operator/reference/servicebus.v1alpha1api20210101preview/" class="">Servicebus.V1alpha1api20210101preview</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://azure.github.io/azure-service-operator/reference/signalrservice.v1alpha1api20211001/" class="">Signalrservice.V1alpha1api20211001</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://azure.github.io/azure-service-operator/reference/storage.v1alpha1api20210401/" class="">Storage.V1alpha1api20210401</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>















</nav>




  <script>(function(){var a=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(b){localStorage.setItem("menu.scrollTop",a.scrollTop)}),a.scrollTop=localStorage.getItem("menu.scrollTop")})()</script>


 
      </div>
    </aside>

    <div class="book-page">
      <header class="book-header">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/azure-service-operator/svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <strong>Adr 2022 01 Reconciler Extensions</strong>

  <label for="toc-control">
    
    <img src="/azure-service-operator/svg/toc.svg" class="book-icon" alt="Table of Contents" />
    
  </label>
</div>


  
  <aside class="hidden clearfix">
    
  
<nav id="TableOfContents">
  <ul>
    <li><a href="#context">Context</a></li>
    <li><a href="#decision">Decision</a>
      <ul>
        <li><a href="#example">Example</a></li>
      </ul>
    </li>
    <li><a href="#status">Status</a></li>
    <li><a href="#consequences">Consequences</a></li>
    <li><a href="#experience-report">Experience Report</a></li>
    <li><a href="#references">References</a></li>
  </ul>
</nav>



  </aside>
  
 
      </header>

      
      
  <article class="markdown"><h1 id="reconciler-extensions">
  Reconciler Extensions
  <a class="anchor" href="#reconciler-extensions">#</a>
</h1>
<h2 id="context">
  Context
  <a class="anchor" href="#context">#</a>
</h2>
<p>We are discovering inconsistencies in the way different Azure Resource Providers behave.</p>
<p>These inconsistencies are anticipated. Given the number of disparate teams independently implementing their providers and given the way the ARM guidance has changed over time, differences in behaviour are to be expected.</p>
<p>For example, the Azure Redis Resource Provider can return a HTTP conflict (409) with a retry message indicating that it&rsquo;s not a fatal error but a transient one.</p>
<p>Currently we handle this with special case behaviour in <code>error_classifier.go</code> (see <a href="https://github.com/Azure/azure-service-operator/pull/2008">PR#2008</a> for details).</p>
<p>However, directly changing our generic reconciler is a problem. The growing complexity and increasing number of resources makes this unsustainable, resulting in a risk that changes made to support a new resource type will break an existing one.</p>
<p>We need a way to precisely customize behaviour on a per-resource basis, allowing us to maintain consistent functionality within the operator.</p>
<p>When a new version of a resource is introduced, we don&rsquo;t want to lose any existing customizations. This rules out hosting the extensions directly on the current hub type.</p>
<p>It&rsquo;s quite likely that some extension points will need to import our generated resource types to allow per-version manipulation. This rules out referencing extensions from the generated resource types.</p>
<p>We don&rsquo;t want extension points to duplicate functionality already present in the generic reconciler as this runs the risk of inconsistencies (especially if we change the generic reconciler itself), and because it introduces a significant overhead to implementation. Instead, extension points will provide an opportunity to modify the current behaviour. An extension point that does nothing should have the same effect as one that hasn&rsquo;t been implemented.</p>
<h2 id="decision">
  Decision
  <a class="anchor" href="#decision">#</a>
</h2>
<p>To provide a stable implementation location for extensions, we&rsquo;ll introduce a dedicated <code>customization</code> package alongside the existing versioned packages for each supported service. This package will provide customization for all supported resource versions. For example, alongside the existing <strong>batch</strong> packages <code>v1alpha1api20210101</code>, and <code>v1alpha1api20210101storage</code>, we will generate <code>customization</code>.</p>
<p>Into the <code>customization</code> package we will codegen a skeleton framework. For each resource there will be a separate customization host type, suffixed with <code>Extensions</code>. For example, for the <strong>compute</strong> resources <code>Disk</code>, <code>VirtualMachine</code>, and <code>VirtualMachineScaleSet</code> we will create the extension types <code>DiskExtensions</code>, <code>VirtualMachineExtensions</code>, and <code>VirtualMachineScaleSetExtensions</code>.</p>
<p>We&rsquo;ll enhance the existing registration file (<code>controller_resources_gen.go</code>) to also provide registration of extensions. They will be indexed by the GVK of each resource, allowing easy lookup by the generic reconciler.</p>
<p>For each supported extension point in our reconciler, we&rsquo;ll define a separate interface containing a single method with exactly the parameters required for that extension point. These interfaces will be found in the <code>genruntime/extensions</code> package.</p>
<p>Implementers will assert type compatibility with the desired extension interface to ensure at compile time they have the correct method signature. This will also ensure we get compilation errors if we unexpectedly need to modify the signature of an extension point in the future.</p>
<p>The generic reconciler will identify available extensions by testing for the presence of the extension interface.</p>
<p>Extension method signature will follow a common pattern:</p>
<ul>
<li>The parameter list will start with any input parameters required.
These parameters will be custom for each extension point.</li>
<li>A <code>next</code> parameter, a <strong>func</strong> that the extension should call to invoke the default behaviour.<br>
This allows the extension to act both <em>before</em> and <em>after</em> the default behaviour, or even to <em>skip</em> the default behaviour if necessary.</li>
<li>An <code>apiVersion</code> parameter that receives the actual ARM API version being used.<br>
This enables extensions to do different things based on the ARM API version, such as correcting the behaviour of one version.</li>
<li>A <code>log</code> parameter allowing additional information to be logged.<br>
Some entry/exit information will be automatically logged, so extensions will only need to log any additions</li>
<li>Optionally, an extension point may return a value.<br>
If multiple return values are needed, these will be wrapped in a custom struct, with a public factory method.</li>
<li>There will always be an <code>error</code> return value, and it will always be the last one.</li>
</ul>
<h3 id="example">
  Example
  <a class="anchor" href="#example">#</a>
</h3>
<p>To allow customization of error handling for Azure Redis, we&rsquo;ll introduce an extension point for classification of errors.</p>
<p>We create the required extension interface in the package <code>genruntime/extensions</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// error_classifier_extension.go
</span><span style="color:#75715e"></span>
<span style="color:#f92672">package</span> <span style="color:#a6e22e">extensions</span>

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">ErrorClassifier</span> <span style="color:#66d9ef">interface</span> {
    <span style="color:#75715e">// Classify the provided error, returning details about the error including whether it is fatal 
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// or can be retried.
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// cloudError is the error returned from ARM.
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// next is the function to call for standard classification behaviour.
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// apiVersion is the ARM API version used for the request.
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// log is a logger than can be used for telemetry.
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">ClassifyError</span>(
        <span style="color:#a6e22e">cloudError</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">genericarmclient</span>.<span style="color:#a6e22e">CloudError</span>, 
        <span style="color:#a6e22e">next</span> <span style="color:#66d9ef">func</span>(<span style="color:#f92672">*</span><span style="color:#a6e22e">genericarmclient</span>.<span style="color:#a6e22e">CloudError</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">CloudErrorDetails</span>, <span style="color:#66d9ef">error</span>),
        <span style="color:#a6e22e">apiVersion</span> <span style="color:#66d9ef">string</span>, 
        <span style="color:#a6e22e">log</span> <span style="color:#a6e22e">logr</span>.<span style="color:#a6e22e">Logger</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">CloudErrorDetails</span>, <span style="color:#66d9ef">error</span>)
}
</code></pre></div><p>In the <code>cache/customization</code> package, a host type for the extension point will be generated:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// redis_extensions.go
</span><span style="color:#75715e"></span>
<span style="color:#f92672">package</span> <span style="color:#a6e22e">customization</span>

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">RedisExtensions</span> <span style="color:#66d9ef">struct</span>{}
</code></pre></div><p>This type doesn&rsquo;t contain any members as we require extension points to be pure functions; if they contain mutable state, we run the risk of introducing concurrency and sequence errors that would be hard to diagnose and fix.</p>
<p>Manual implementation of the extension point will be in a different file so that it&rsquo;s not obliterated next time we re-run the generator:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// redis_extensions.go
</span><span style="color:#75715e"></span>
<span style="color:#f92672">package</span> <span style="color:#a6e22e">customization</span>

<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">_</span> <span style="color:#a6e22e">extensions</span>.<span style="color:#a6e22e">ErrorClassifier</span> = <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">RedisExtensions</span>{}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">e</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">RedisExtensions</span>) <span style="color:#a6e22e">ClassifyError</span>(
    <span style="color:#a6e22e">cloudError</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">genericarmclient</span>.<span style="color:#a6e22e">CloudError</span>, 
    <span style="color:#a6e22e">next</span> <span style="color:#66d9ef">func</span>(<span style="color:#f92672">*</span><span style="color:#a6e22e">genericarmclient</span>.<span style="color:#a6e22e">CloudError</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">CloudErrorDetails</span>,
    <span style="color:#a6e22e">apiVersion</span> <span style="color:#66d9ef">string</span>, 
    <span style="color:#a6e22e">log</span> <span style="color:#a6e22e">logr</span>.<span style="color:#a6e22e">Logger</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">CloudErrorDetails</span>, <span style="color:#66d9ef">error</span>)

    <span style="color:#a6e22e">err</span>, <span style="color:#a6e22e">result</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">next</span>(<span style="color:#a6e22e">cloudError</span>)
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
    }

    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">inner</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">cloudError</span>.<span style="color:#a6e22e">InnerError</span>; <span style="color:#a6e22e">inner</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#a6e22e">code</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">to</span>.<span style="color:#a6e22e">String</span>(<span style="color:#a6e22e">inner</span>.<span style="color:#a6e22e">Code</span>)
        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">code</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;Conflict&#34;</span> {
            <span style="color:#75715e">// For Azure Redis, Conflict errors may be retried, as they are 
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// returned when a required dependency is still being created
</span><span style="color:#75715e"></span>            <span style="color:#a6e22e">result</span>.<span style="color:#a6e22e">Classification</span> = <span style="color:#a6e22e">CloudErrorRetryable</span>
        }
    }

    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">result</span>, <span style="color:#66d9ef">nil</span>
}
</code></pre></div><p>Passing in the default behaviour as <code>next</code> allows extensions to augment and/or supplant the behaviour with a great deal of flexibility.</p>
<p>In the generic reconciler, we make use of the extension:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// azure_generic_arm_reconciler.go
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">AzureDeploymentReconciler</span>) <span style="color:#a6e22e">makeReadyConditionFromError</span>(
    <span style="color:#a6e22e">cloudError</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">genericarmclient</span>.<span style="color:#a6e22e">CloudError</span>) <span style="color:#a6e22e">conditions</span>.<span style="color:#a6e22e">Condition</span> {
    <span style="color:#75715e">// ... existing code elided ...
</span><span style="color:#75715e"></span>
    <span style="color:#a6e22e">ext</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">FindErrorClassifierExtension</span>()
    <span style="color:#a6e22e">errorDetails</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ext</span>.<span style="color:#a6e22e">ClassifyError</span>(<span style="color:#a6e22e">cloudError</span>, <span style="color:#a6e22e">apiVersion</span>, <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">ClassifyCloudError</span>)
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#75715e">// handle error
</span><span style="color:#75715e"></span>    }

    <span style="color:#75715e">// ... existing code elided ...
</span><span style="color:#75715e"></span>}
</code></pre></div><p>The helper method <code>FindErrorClassifierExtension()</code> does the lookup for the extension, and always returns a default implementation that can be invoked. The consuming code therefore doesn&rsquo;t need to worry about null checking, only error handling. To ensure consistent telemetry no matter who implements an extension, this default implementation will include logging.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// error_classifier_extension.go
</span><span style="color:#75715e"></span>
<span style="color:#f92672">package</span> <span style="color:#a6e22e">extensions</span>

<span style="color:#75715e">//TODO: This needs a better name
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">ErrorClassifierDefault</span> <span style="color:#66d9ef">struct</span> {
    <span style="color:#a6e22e">extension</span> <span style="color:#a6e22e">ErrorClassifierExtension</span>
}

<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">_</span> <span style="color:#a6e22e">ErrorClassifier</span> = <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">ErrorClassifierDefault</span>{}

<span style="color:#75715e">// NewErrorClassifierDefault creates a new ErrorClassifier that will invoke the passed host if it implements 
</span><span style="color:#75715e">// the ErrorClassifier interface.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewErrorClassifier</span>(<span style="color:#a6e22e">host</span> <span style="color:#66d9ef">interface</span>{}) <span style="color:#f92672">*</span><span style="color:#a6e22e">LoggingErrorClassifier</span> {
    <span style="color:#a6e22e">result</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">ErrorClassifier</span>{}

    <span style="color:#75715e">// Hook up our host if appropriate
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">extension</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">host</span>.(<span style="color:#a6e22e">ErrorClassifierExtension</span>); <span style="color:#a6e22e">ok</span> {
        <span style="color:#a6e22e">result</span>.<span style="color:#a6e22e">extension</span> = <span style="color:#a6e22e">extension</span>
    }

    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">result</span>
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">classifier</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">ErrorClassifier</span>) <span style="color:#a6e22e">ClassifyError</span>(
    <span style="color:#a6e22e">cloudError</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">genericarmclient</span>.<span style="color:#a6e22e">CloudError</span>, 
    <span style="color:#a6e22e">next</span> <span style="color:#66d9ef">func</span>(<span style="color:#f92672">*</span><span style="color:#a6e22e">genericarmclient</span>.<span style="color:#a6e22e">CloudError</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">CloudErrorDetails</span>, <span style="color:#66d9ef">error</span>),
    <span style="color:#a6e22e">apiVersion</span> <span style="color:#66d9ef">string</span>, 
    <span style="color:#a6e22e">log</span> <span style="color:#a6e22e">logr</span>.<span style="color:#a6e22e">Logger</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">CloudErrorDetails</span>, <span style="color:#66d9ef">error</span>) {

    <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">V</span>(<span style="color:#a6e22e">Verbose</span>).<span style="color:#a6e22e">Info</span>(<span style="color:#e6db74">&#34;Classifying error&#34;</span>, <span style="color:#e6db74">&#34;error&#34;</span>, <span style="color:#a6e22e">cloudError</span>)

    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">details</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">CloudErrorDetails</span>
    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">classifier</span>.<span style="color:#a6e22e">extension</span> <span style="color:#f92672">!=</span> <span style="color:#a6e22e">null</span> {
      <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">V</span>(<span style="color:#a6e22e">Verbose</span>).<span style="color:#a6e22e">Info</span>(<span style="color:#e6db74">&#34;Invoking extension&#34;</span>)
      <span style="color:#a6e22e">details</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">classifier</span>.<span style="color:#a6e22e">extension</span>.<span style="color:#a6e22e">ClassifyError</span>(<span style="color:#a6e22e">cloudError</span>, <span style="color:#a6e22e">next</span>, <span style="color:#a6e22e">apiVersion</span>, <span style="color:#a6e22e">log</span>)
    } <span style="color:#66d9ef">else</span> {
      <span style="color:#a6e22e">details</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">next</span>(<span style="color:#a6e22e">cloudError</span>, <span style="color:#a6e22e">next</span>, <span style="color:#a6e22e">apiVersion</span>, <span style="color:#a6e22e">log</span>)
    }

    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
      <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Error</span>(<span style="color:#e6db74">&#34;Failure classifying error&#34;</span>, <span style="color:#e6db74">&#34;error&#34;</span>, <span style="color:#a6e22e">err</span>)
    } <span style="color:#66d9ef">else</span> {
      <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">V</span>(<span style="color:#a6e22e">Verbose</span>).<span style="color:#a6e22e">Info</span>(<span style="color:#e6db74">&#34;Success classifying error&#34;</span>, <span style="color:#e6db74">&#34;result&#34;</span>, <span style="color:#a6e22e">details</span>)
    }

    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">details</span>, <span style="color:#a6e22e">err</span>
}
</code></pre></div><h2 id="status">
  Status
  <a class="anchor" href="#status">#</a>
</h2>
<p>Proposed.</p>
<h2 id="consequences">
  Consequences
  <a class="anchor" href="#consequences">#</a>
</h2>
<p>TBC.</p>
<h2 id="experience-report">
  Experience Report
  <a class="anchor" href="#experience-report">#</a>
</h2>
<p>TBC.</p>
<h2 id="references">
  References
  <a class="anchor" href="#references">#</a>
</h2>
</article>
 
      

      <footer class="book-footer">
        
  <div class="flex flex-wrap justify-between">





</div>



  <script>(function(){function a(c){const a=window.getSelection(),b=document.createRange();b.selectNodeContents(c),a.removeAllRanges(),a.addRange(b)}document.querySelectorAll("pre code").forEach(b=>{b.addEventListener("click",function(c){a(b.parentElement),navigator.clipboard&&navigator.clipboard.writeText(b.parentElement.textContent)})})})()</script>


 
        
      </footer>

      
  
  <div class="book-comments">

</div>
  
 

      <label for="menu-control" class="hidden book-menu-overlay"></label>
    </div>

    
    <aside class="book-toc">
      <div class="book-toc-content">
        
  
<nav id="TableOfContents">
  <ul>
    <li><a href="#context">Context</a></li>
    <li><a href="#decision">Decision</a>
      <ul>
        <li><a href="#example">Example</a></li>
      </ul>
    </li>
    <li><a href="#status">Status</a></li>
    <li><a href="#consequences">Consequences</a></li>
    <li><a href="#experience-report">Experience Report</a></li>
    <li><a href="#references">References</a></li>
  </ul>
</nav>


 
      </div>
    </aside>
    
  </main>

  
</body>
</html>












