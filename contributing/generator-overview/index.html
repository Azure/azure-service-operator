<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Code Generator Overview #  Core to Azure Service Operator (ASO) v2 is our code generator. This consumes ARM JSON Schema and Swagger specifications and generates code for each desired resource that works with our generic operator reconciler.
Code Structure #  Key packages used to structure the code of the generator are as follows:
   Package Content     astmodel Short for Abstract Syntax Tree Model, this package contains the core data types for defining the Go functions, data types, and methods we generate.">
<meta name="theme-color" content="#FFFFFF">
<meta name="color-scheme" content="light dark"><meta property="og:title" content="" />
<meta property="og:description" content="Code Generator Overview #  Core to Azure Service Operator (ASO) v2 is our code generator. This consumes ARM JSON Schema and Swagger specifications and generates code for each desired resource that works with our generic operator reconciler.
Code Structure #  Key packages used to structure the code of the generator are as follows:
   Package Content     astmodel Short for Abstract Syntax Tree Model, this package contains the core data types for defining the Go functions, data types, and methods we generate." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://azure.github.io/azure-service-operator/contributing/generator-overview/" /><meta property="article:section" content="contributing" />



<title>Generator Overview | Azure Service Operator</title>
<link rel="manifest" href="/azure-service-operator/manifest.json">
<link rel="icon" href="/azure-service-operator/favicon.png" type="image/x-icon">
<link rel="stylesheet" href="/azure-service-operator/book.min.46181bc93375ba932026e753b37c40e6ff8bb16a9ef770c78bcc663e4577b1ba.css" integrity="sha256-RhgbyTN1upMgJudTs3xA5v&#43;LsWqe93DHi8xmPkV3sbo=" crossorigin="anonymous">
  <script defer src="/azure-service-operator/flexsearch.min.js"></script>
  <script defer src="/azure-service-operator/en.search.min.9c86a3e4372c51b0ed9e964bc5d2e58bda3eff32a8d29c67d7e40f4117cbdc0c.js" integrity="sha256-nIaj5DcsUbDtnpZLxdLli9o&#43;/zKo0pxn1&#43;QPQRfL3Aw=" crossorigin="anonymous"></script>
<!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->
  
</head>
<body dir="ltr">
  <input type="checkbox" class="hidden toggle" id="menu-control" />
  <input type="checkbox" class="hidden toggle" id="toc-control" />
  <main class="container flex">
    <aside class="book-menu">
      <div class="book-menu-content">
        
  <nav>
<h2 class="book-brand">
  <a class="flex align-center" href="/azure-service-operator/"><span>Azure Service Operator</span>
  </a>
</h2>


<div class="book-search">
  <input type="text" id="book-search-input" placeholder="Search" aria-label="Search" maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>












  

  



  
  <ul>
    
      
        <li>
          
  
  

  
    <span>Userâ€™s Guide</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://azure.github.io/azure-service-operator/introduction/annotations/" class="">Annotations</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://azure.github.io/azure-service-operator/introduction/authentication/" class="">Authentication</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://azure.github.io/azure-service-operator/introduction/multitenant-deployment/" class="">Multitenant Deployment</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://azure.github.io/azure-service-operator/introduction/resources/" class="">Resources</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://azure.github.io/azure-service-operator/introduction/tutorial-cosmosdb/" class="">Tutorial: CosmosDB to-do List</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://azure.github.io/azure-service-operator/introduction/tutorial-postgresql/" class="">Tutorial: PostgreSQL Votes</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>For Contributors</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://azure.github.io/azure-service-operator/contributing/contributing/" class="">Contributing</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://azure.github.io/azure-service-operator/contributing/add-a-new-code-generated-resource/" class="">Add a New Code Generated Resource</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://azure.github.io/azure-service-operator/contributing/create-a-new-release/" class="">Create a New Release</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://azure.github.io/azure-service-operator/contributing/generator-overview/" class=" active">Generator Overview</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>Design &amp; Specifications</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://azure.github.io/azure-service-operator/design/clarifying-object-structure/" class="">Clarifying Object Structure</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://azure.github.io/azure-service-operator/design/crossplane/" class="">Crossplane</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://azure.github.io/azure-service-operator/design/defaulter-validator/" class="">Defaulter Validator</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://azure.github.io/azure-service-operator/design/resource-states/" class="">Resource States</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://azure.github.io/azure-service-operator/design/secrets/" class="">Secrets</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://azure.github.io/azure-service-operator/design/type-references-and-ownership/" class="">Type References and Ownership</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://azure.github.io/azure-service-operator/design/versioning/" class="">Versioning</a>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <span>Case Studies</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://azure.github.io/azure-service-operator/design/versioning/case-studies/chained-storage-versions/" class="">Chained Storage Versions</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://azure.github.io/azure-service-operator/design/versioning/case-studies/fixed-storage-version/" class="">Fixed Storage Version</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://azure.github.io/azure-service-operator/design/versioning/case-studies/rolling-storage-versions/" class="">Rolling Storage Versions</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://azure.github.io/azure-service-operator/architecture-decision-records/" class="">Architecture Decision Records</a>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://azure.github.io/azure-service-operator/architecture-decision-records/adr-2021-02-property-conversions/" class="">2021-02: Property Conversions</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://azure.github.io/azure-service-operator/architecture-decision-records/adr-2020-11-abstract-syntax-trees/" class="">2020-11: AST Library Choice</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://azure.github.io/azure-service-operator/architecture-decision-records/adr-2020-07-pipeline-architecture/" class="">2020-07: Pipeline Architecture</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://azure.github.io/azure-service-operator/architecture-decision-records/adr-2020-04-code-generation/" class="">2020-04: Why Code Generation?</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://azure.github.io/azure-service-operator/architecture-decision-records/adr-2021-06-api-version-recovery/" class="">Adr 2021 06 API Version Recovery</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://azure.github.io/azure-service-operator/architecture-decision-records/adr-2022-01-reconciler-extensions/" class="">Adr 2022 01 Reconciler Extensions</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>















</nav>




  <script>(function(){var a=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(b){localStorage.setItem("menu.scrollTop",a.scrollTop)}),a.scrollTop=localStorage.getItem("menu.scrollTop")})()</script>


 
      </div>
    </aside>

    <div class="book-page">
      <header class="book-header">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/azure-service-operator/svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <strong>Generator Overview</strong>

  <label for="toc-control">
    
    <img src="/azure-service-operator/svg/toc.svg" class="book-icon" alt="Table of Contents" />
    
  </label>
</div>


  
  <aside class="hidden clearfix">
    
  
<nav id="TableOfContents">
  <ul>
    <li><a href="#code-structure">Code Structure</a>
      <ul>
        <li><a href="#directory-structure-overview">Directory structure overview</a></li>
      </ul>
    </li>
    <li><a href="#object-model">Object Model</a></li>
    <li><a href="#resources-objects-and-other-types">Resources, Objects and other types</a></li>
    <li><a href="#generator-pipeline">Generator Pipeline</a></li>
    <li><a href="#code-generation">Code Generation</a></li>
  </ul>
</nav>



  </aside>
  
 
      </header>

      
      
  <article class="markdown"><h1 id="code-generator-overview">
  Code Generator Overview
  <a class="anchor" href="#code-generator-overview">#</a>
</h1>
<p>Core to Azure Service Operator (ASO) v2 is our code generator. This consumes ARM JSON Schema and Swagger specifications and generates code for each desired resource that works with our generic operator reconciler.</p>
<h2 id="code-structure">
  Code Structure
  <a class="anchor" href="#code-structure">#</a>
</h2>
<p>Key packages used to structure the code of the generator are as follows:</p>
<table>
<thead>
<tr>
<th>Package</th>
<th>Content</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>astmodel</code></td>
<td>Short for <em>Abstract Syntax Tree Model</em>, this package contains the core data types for defining the Go functions, data types, and methods we generate.</td>
</tr>
<tr>
<td><code>functions</code></td>
<td>Support for generation of individual functions, based on the <code>astmodel.Functions</code> interface</td>
</tr>
<tr>
<td><code>interfaces</code></td>
<td>Support for generation of interface implementations, based on the <code>astmodel.InterfaceImplementer</code> interface</td>
</tr>
<tr>
<td><code>testcases</code></td>
<td>Support for generation of test cases (used to verify our generated code works as expected), based on the <code>astmodel.TestCase</code> interface</td>
</tr>
<tr>
<td><code>astbuilder</code></td>
<td>Intention revealing utility methods for creating the underlying Go abstract syntax tree we serialize as the last step of generation.</td>
</tr>
<tr>
<td><code>codegen</code></td>
<td>The core processing pipeline of the code generator</td>
</tr>
<tr>
<td><code>codegen/pipeline</code></td>
<td>Individual pipeline stages that are composed to form the code generator itself.</td>
</tr>
<tr>
<td><code>test</code></td>
<td>Support methods to make writing tests easier</td>
</tr>
</tbody>
</table>
<h3 id="directory-structure-overview">
  Directory structure overview
  <a class="anchor" href="#directory-structure-overview">#</a>
</h3>
<p>In this diagram is shown the full directory structure of the ASO code generator, including all the packages named above.</p>
<p><img src="contributing/aso-codegen-structure.svg" alt="Overview" /></p>
<p>The size of each dot reflects the size of the file; the legend in the corner shows the meaning of colour.</p>
<h2 id="object-model">
  Object Model
  <a class="anchor" href="#object-model">#</a>
</h2>
<p>At the core, the code generator works with a rich semantic object model that captures the structure of the resources (and related types) we are generating.</p>
<p>Underpinning this object model is the <code>astmodel</code> package.</p>
<p>The interface <code>astmodel.Type</code> represents a specific data type. The most widely used implementations of <code>Type</code> fall into a few separate groups:</p>
<ul>
<li>Simple Go types, including <code>PrimitiveType</code>, <code>ArrayType</code>, and <code>MapType</code>.</li>
<li>Complex types with internal structure, most notably <code>ObjectType</code> and <code>ResourceType</code>.</li>
<li>Wrapper types that provide additional semantics, including <code>OptionalType</code>, <code>ErroredType</code>, <code>FlaggedType</code> and <code>ValidatedType</code>.</li>
</ul>
<p>This list is not exhaustive; other implementations of <code>Type</code> are used within limited scopes. For example, <code>AllOfType</code> and <code>OneOfType</code> represent JSON Schema techniques for creating object definitions via composition.</p>
<p>Usefully, there is also <code>TypeName</code> which is both a type in itself and an indirect reference to a type defined elsewhere.</p>
<p>When a <code>Type</code> is given a <code>TypeName</code>, it becomes a <code>TypeDefinition</code> and can be emitted as the source code for a Go type definition. A set of many <code>TypeDefinition</code>, each with a unique name is a <code>Types</code>.</p>
<p>Both <code>ResourceType</code> and <code>ObjectType</code> act as containers, each implementing <code>PropertyContainer</code>, <code>FunctionContainer</code>, and <code>TestCaseContainer</code>. These do pretty much what you&rsquo;d expect from the names, though the implementations differ between <code>ResourceType</code> and <code>ObjectType</code>. For example, where an <code>ObjectType</code> implements <code>PropertyContainer</code> by providing support for an arbitrary set of properties, <code>ResourceType</code> has only <code>Spec</code> and <code>Status</code>.</p>
<p>Most implementations of <code>astmodel.Function</code> are found in the <strong>functions</strong> package. New function implementations should go here; existing implementations are slowly being relocated.</p>
<p>All implementations of <code>astmodel.TestCase</code> are found in the <strong>testcases</strong> package. New test case implementations should go here.</p>
<h2 id="resources-objects-and-other-types">
  Resources, Objects and other types
  <a class="anchor" href="#resources-objects-and-other-types">#</a>
</h2>
<p>Each distinct resource is represented by a <code>ResourceType</code>. The <code>Spec</code> of each resource is an <code>ObjectType</code> containing a collection of <code>PropertyDefinition</code> values, along with implementations of the <code>Function</code>, and <code>TestCase</code> interfaces. The <code>Status</code> of a resource is a different <code>ObjectType</code>.</p>
<p>Some properties capture primitive values (strings, integers, and so on), while others are themselves complex <code>ObjectType</code> definitions, forming a hierarchy of information. <code>MetaType</code> wrappers (including <code>OptionalType</code>, and <code>ValidatedType</code>) are used to add semantic information to both properties and to type definitions.</p>
<h2 id="generator-pipeline">
  Generator Pipeline
  <a class="anchor" href="#generator-pipeline">#</a>
</h2>
<p>The code generator itself, found in the package <code>codegen</code>, is structured as a pipeline, composed of a series of stages that transform our object model incrementally. All the pipeline stages are found in the subpackage <code>codegen/pipeline</code>.</p>
<p>One reason for this is to allow the creation of multiple pipelines (currently we have separate definitions targeting Azure, Crossplane, and for testing), each sharing the majority of their implementation. Another reason is to allow individual pipeline stages to be tested in isolation, though not all existing pipeline stages have tests in this form. New stage implementations should have isolated tests where possible.</p>
<p>Pipeline stages are instances of <code>pipeline.Stage</code>. Each has a factory method that returns a <code>pipeline.Stage</code> instance. In operation, each accepts a <code>pipeline.State</code> containing the current object model and transforms it into a new state, that is passed to the next stage in turn. If a stage returns an error, the pipeline run is aborted.</p>
<p>New stages should use the <code>MakeStage()</code> function. You&rsquo;ll see some older stages that predate a structural change use the deprecated <code>MakeLegacyStage()</code> factory instead; these older stages are slowly being migrated and <code>MakeLegacyStage()</code> will be deleted when this is complete.</p>
<h2 id="code-generation">
  Code Generation
  <a class="anchor" href="#code-generation">#</a>
</h2>
<p>Code is generated as a Go abstract syntax tree fragments which are then serialized to files as compilable Go code, forming a part of the operator itself.</p>
<p>To make generation easier, our <code>astbuilder</code> package contains a wide variety of helper methods that allow declarative construction of the required tree. We are using the <code>dst</code> package instead of the Go core <code>ast</code> package, as it provides better control of comments and whitespace in the final output.</p>
</article>
 
      

      <footer class="book-footer">
        
  <div class="flex flex-wrap justify-between">





</div>



  <script>(function(){function a(c){const a=window.getSelection(),b=document.createRange();b.selectNodeContents(c),a.removeAllRanges(),a.addRange(b)}document.querySelectorAll("pre code").forEach(b=>{b.addEventListener("click",function(c){a(b.parentElement),navigator.clipboard&&navigator.clipboard.writeText(b.parentElement.textContent)})})})()</script>


 
        
      </footer>

      
  
  <div class="book-comments">

</div>
  
 

      <label for="menu-control" class="hidden book-menu-overlay"></label>
    </div>

    
    <aside class="book-toc">
      <div class="book-toc-content">
        
  
<nav id="TableOfContents">
  <ul>
    <li><a href="#code-structure">Code Structure</a>
      <ul>
        <li><a href="#directory-structure-overview">Directory structure overview</a></li>
      </ul>
    </li>
    <li><a href="#object-model">Object Model</a></li>
    <li><a href="#resources-objects-and-other-types">Resources, Objects and other types</a></li>
    <li><a href="#generator-pipeline">Generator Pipeline</a></li>
    <li><a href="#code-generation">Code Generation</a></li>
  </ul>
</nav>


 
      </div>
    </aside>
    
  </main>

  
</body>
</html>












