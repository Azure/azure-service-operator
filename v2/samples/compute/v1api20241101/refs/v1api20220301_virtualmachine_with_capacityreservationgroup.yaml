apiVersion: compute.azure.com/v1api20220301
kind: VirtualMachine
metadata:
  name: sample-vm-with-capacity-reservation
  namespace: default
spec:
  location: eastus
  owner:
    name: sample-rg
  hardwareProfile:
    vmSize: Standard_D2s_v3
  osProfile:
    computerName: sample-vm
    adminUsername: azureuser
    linuxConfiguration:
      disablePasswordAuthentication: true
      ssh:
        publicKeys:
          - path: /home/azureuser/.ssh/authorized_keys
            keyData: ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC... # Your SSH public key
  storageProfile:
    imageReference:
      publisher: Canonical
      offer: 0001-com-ubuntu-server-focal
      sku: 20_04-lts-gen2
      version: latest
    osDisk:
      name: sample-vm-os-disk
      caching: ReadWrite
      createOption: FromImage
      managedDisk:
        storageAccountType: Premium_LRS
  networkProfile:
    networkInterfaces:
      - reference:
          group: network.azure.com
          kind: NetworkInterface
          name: sample-vm-nic
  # This is the key part - referencing the CapacityReservationGroup
  capacityReservation:
    capacityReservationGroup:
      reference:
        group: compute.azure.com
        kind: CapacityReservationGroup
        name: sample-capacity-reservation-group
---
apiVersion: compute.azure.com/v1api20241101
kind: CapacityReservationGroup
metadata:
  name: sample-capacity-reservation-group
  namespace: default
spec:
  location: eastus
  owner:
    name: sample-rg
  tags:
    environment: production
    purpose: vm-capacity-guarantee
  zones:
    - "1"
